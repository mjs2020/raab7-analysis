---
output:
  pdf_document:
    toc: FALSE
---

```{r setup, include=FALSE}

require(rmarkdown)
require(readxl)
require(knitr)
require(tinytex)
require(kableExtra)
require(float)
require(RColorBrewer)
#install_tinytex()

require(tidyverse)
require(stringr)
require(treemap)
require(maditr)
require(here)

options(knitr.table.format = "latex")
knitr::opts_chunk$set(echo = FALSE)

if(dir.exists(here("outputs",ID))){
print("Directory already exists")
} else {
dir.create(here("outputs",ID,"/summary"))
dir.create(here("outputs",ID,"/summary/data"))
dir.create(here("outputs",ID,"/raw"))
dir.create(here("outputs",ID,"/raw/data"))
}

raab_merged<-read.csv(here("data", "surveys.csv"))

raab<-raab_merged[raab_merged$raab_id==ID,]
raab$date<-as.Date(raab$date)

pop_merged<-read.csv(here("data", "population.csv"))
									   
pop<-pop_merged[pop_merged$raab_id==ID,]
popfives<-pop

meta<-read.csv(here("data","meta.csv"))

raab_meta<-meta[meta$raab_id==ID,]

PI<-raab_meta$pi_name
TITLE<-raab_meta$survey_title

write.table(raab_meta, here("outputs", ID, "raw", "meta.csv"),row.names=F,col.names=T,sep=",",na="")
write.table(raab, here("outputs", ID, "raw", "data", "survey_data.csv"),row.names=F,col.names=T,sep=",")
write.table(popfives, here("outputs", ID, "raw", "data","population.csv"),row.names=F,col.names=T,sep=",")

source(here("RAAB7_scripts", "raab_functions.R"))

```

---
title: |
  <center>Rapid Assessment of Avoidable Blindness
  <center>Diabetic Retinopathy module sub-report 
subtitle: |
  | 
  | Sub-report of findings from `r TITLE`
author: Principal Investigator `r PI`
output:
  pdf_document:
    toc: FALSE
header-includes:
- \usepackage{float}
- \usepackage{tabu}
- \usepackage{graphicx}
- \usepackage{fancyhdr}
- \fancypagestyle{plain}{\pagestyle{fancy}}
- \fancyhead[R]{\includegraphics[width=5cm]{logo.png}}
tables:
  yes
---

```{r raab_report_setup, include=FALSE}

source(here("RAAB7_scripts","RAAB7_report_setup.R"))

```

\center

Survey completed: `r format(max(raab$date), '%d %B %Y')`

Report generated: `r format(Sys.time(), '%d %B %Y')`

\raggedright

```{=latex}
\tableofcontents
```

\newpage

# Diabetic retinopathy

## Table DR1

The response rate for the diabetic retinopathy (DR) module can be lower than the standard RAAB survey if participants do not consent to a random blood sugar test (see Table 2) or to a dilated eye examination (see Table 3). Those who do not consent to dilated examination may differ from those who do. For example, they may be younger (e.g., working age rather than retired) or drivers, with the appropriate level of vision required to hold a driving licence.



```{r dr-response-rate-a,echo=FALSE}

source(here("RAAB7_scripts","dr-response-rate.R"))

dr.response.a.nice.names<-dr.response.a

write.table(dr.response.a.nice.names,here("outputs", ID, "summary", "data", "dr1.csv"),row.names=F,col.names=T,sep=",")

dr.response.a.nice.names$Exam.Status[dr.response.a.nice.names$Exam.Status=="Diabetes status assessed"]<-"Diabetes status assessed*"

names(dr.response.a.nice.names)<-c("","n","%","n","%","n","%")

knitr::kable(dr.response.a.nice.names, booktabs=T, linesep = "", caption = "RAAB survey and DR module response rate") %>% 
  kable_styling(full_width=T, latex_options = "HOLD_position") %>%
  row_spec(0,italic=TRUE) %>%
  column_spec(1,width='5cm') %>%
  add_header_above(c("Exam status" = 1, "Female" = 2, "Male" = 2, "Total" = 2),bold=T) %>%
  add_footnote("Self-reported diabetes or consented to random blood sugar test",notation = "symbol")

```

## Table DR2

```{r dr-response-rate-b,echo=FALSE}

source(here("RAAB7_scripts","dr-response-rate.R"))

dr.response.b.nice.names<-dr.response.b

write.table(dr.response.b.nice.names,here("outputs", ID, "summary", "data", "dr2.csv"),row.names=F,col.names=T,sep=",")

dr.response.b.nice.names$Exam.Status[dr.response.b.nice.names$Exam.Status=="Suspected"]<-"Suspected*"

names(dr.response.b.nice.names)<-c("","n","%","n","%","n","%")

knitr::kable(dr.response.b.nice.names, booktabs=T, linesep = "", caption = "Known or suspected diabetes among participants assessed for diabetes status") %>% 
  kable_styling(full_width=T, latex_options = "HOLD_position") %>%
  row_spec(0,italic=TRUE) %>%
  column_spec(1,width='5cm') %>%
  add_indent(c(2,3),level_of_indent = 1) %>%
  add_header_above(c("Exam status" = 1, "Female" = 2, "Male" = 2, "Total" = 2),bold=T) %>%
  add_footnote("No known history of diabetes but random blood glucose 200mg/dl or higher",notation = "symbol")

```

The proportions of diabetes that is diagnosed and undiagnosed in a population varies by region. The 2021 International Diabetes Federation Atlas (https://diabetesatlas.org/) estimates that more than half of people with diabetes are undiagnosed in Africa (53.6%), Western Pacific (52.8%) and South-East Asia (51.3%).

Note: The use of random blood glucose testing without fasting may result in over-estimates of suspected diabetes in RAAB surveys.

## Table DR3

```{r dr-prev-dm-age-gender, echo=FALSE}

source(here("RAAB7_scripts","dr-prev-dm-age-gender.R"))

dm.prev.final.nice.names<-dm.prev.final

dm.prev.final.nice.names$female.ci<-paste0(dm.prev.final.nice.names$female.pct.lci," - ", dm.prev.final.nice.names$female.pct.uci)
dm.prev.final.nice.names$male.ci<-paste0(dm.prev.final.nice.names$male.pct.lci," - ", dm.prev.final.nice.names$male.pct.uci)
dm.prev.final.nice.names$total.ci<-paste0(dm.prev.final.nice.names$total.pct.lci," - ", dm.prev.final.nice.names$total.pct.uci)

dm.prev.final.nice.names<-dm.prev.final.nice.names[,c("age.groups.tens","female.n","female.pct","female.ci","male.n","male.pct","male.ci","total.n","total.pct","total.ci")]

write.table(dm.prev.final.nice.names,here("outputs", ID, "summary", "data", "dr3.csv"),row.names=F,col.names=T,sep=",")

names(dm.prev.final.nice.names)<-c("Years","n","%","95% CI","n","%","95% CI","n","%","95% CI")

knitr::kable(dm.prev.final.nice.names, booktabs=T, linesep = "", caption = "The prevalence of known or suspected diabetes among participants assessed for diabetes status, by age group and gender") %>% 
  kable_styling(latex_options = c("scale_down", "HOLD_position"), font_size = 8) %>%
  row_spec(0,italic=TRUE) %>%
  row_spec(4,hline_after=T) %>%
  add_header_above(c("Age group" = 1, "Female" = 3, "Male" = 3, "Total" = 3),bold=T)

```

The crude prevalence of diabetes among DR module participants by 10-year age group and gender is shown in Table DR2. A diagnosis of diabetes is based on either a self-reported history of diabetes (“known diabetes”), or, where diabetes is not self-reported, on a random blood sugar of 200 mg/dl or higher (“suspected diabetes”).

## Table DR4

```{r dr-last-eye-exam,echo=FALSE}

source(here("RAAB7_scripts","dr-last-eye-exam.R"))

dr.last.exam.table.nice.names<-dr.last.exam.table

write.table(dr.last.exam.table.nice.names,here("outputs", ID, "summary", "data", "t33.csv"),row.names=F,col.names=T,sep=",")

dr.last.exam.table.nice.names$last.dr.exam[dr.last.exam.table.nice.names$last.dr.exam=="dr_diabetic_last_exam_none"]<-"Never"
dr.last.exam.table.nice.names$last.dr.exam[dr.last.exam.table.nice.names$last.dr.exam=="dr_diabetic_last_exam_0_12_months"]<-"Within 1 year"
dr.last.exam.table.nice.names$last.dr.exam[dr.last.exam.table.nice.names$last.dr.exam=="dr_diabetic_last_exam_13_24_months"]<-"1-2 years"
dr.last.exam.table.nice.names$last.dr.exam[dr.last.exam.table.nice.names$last.dr.exam=="dr_diabetic_last_exam_over_24_months"]<-"More than 2 years"

names(dr.last.exam.table.nice.names)<-c("","n","%","n","%","n","%")

knitr::kable(dr.last.exam.table.nice.names, booktabs=T, linesep = "", caption = "Self-reported time since last eye examination for diabetic retinopathy among known diabetics") %>% 
  kable_styling(full_width=T, latex_options = "HOLD_position") %>%
  row_spec(0,italic=TRUE) %>%
  row_spec(4,hline_after=T) %>%
  column_spec(1,width='5cm') %>%
  add_header_above(c("Last exam" = 1, "Female" = 2, "Male" = 2, "Total" = 2),bold=T) 

```

Self-reported time since last eye examination for DR among known diabetics can be considered as a proxy for the coverage of DR (screening) services. Recall bias may affect the reliability of the findings and results should be reviewed alongside facility-based DR screening records where available.

## Table DR5

```{r dr-prev-dr-in-diabetics, echo=FALSE}

source(here("RAAB7_scripts","dr-prev-dr-in-diabetics.R"))

any.dr.mac.laser.prev.nice.names<-any.dr.mac.laser.prev

any.dr.mac.laser.prev.nice.names$female.ci<-paste0(any.dr.mac.laser.prev.nice.names$female.pct.lci," - ", any.dr.mac.laser.prev.nice.names$female.pct.uci)
any.dr.mac.laser.prev.nice.names$male.ci<-paste0(any.dr.mac.laser.prev.nice.names$male.pct.lci," - ", any.dr.mac.laser.prev.nice.names$male.pct.uci)
any.dr.mac.laser.prev.nice.names$total.ci<-paste0(any.dr.mac.laser.prev.nice.names$total.pct.lci," - ", any.dr.mac.laser.prev.nice.names$total.pct.uci)

any.dr.mac.laser.prev.nice.names<-any.dr.mac.laser.prev.nice.names[,c("condition","female.n","female.pct","female.ci","male.n","male.pct","male.ci","total.n","total.pct","total.ci")]

write.table(any.dr.mac.laser.prev.nice.names,here("outputs", ID, "summary", "data", "t34.csv"),row.names=F,col.names=T,sep=",")

any.dr.mac.laser.prev.nice.names$condition[any.dr.mac.laser.prev.nice.names$condition=="retinopathy.grade"]<-"Any retinopathy"
any.dr.mac.laser.prev.nice.names$condition[any.dr.mac.laser.prev.nice.names$condition=="maculopathy.grade"]<-"Any maculopathy"
any.dr.mac.laser.prev.nice.names$condition[any.dr.mac.laser.prev.nice.names$condition=="any.dr.mac"]<-"Any retinopathy and/or maculopathy"
any.dr.mac.laser.prev.nice.names$condition[any.dr.mac.laser.prev.nice.names$condition=="any.stdr"]<-"Sight-threatening DR (R4 and/or M2)"
any.dr.mac.laser.prev.nice.names$condition[any.dr.mac.laser.prev.nice.names$condition=="any.laser"]<-"Any laser scars"

names(any.dr.mac.laser.prev.nice.names)<-c(" ","n","%","95% CI","n","%","95% CI","n","%","95% CI")

knitr::kable(any.dr.mac.laser.prev.nice.names, booktabs=T, linesep = "", caption = "The prevalence of retinopathy and maculopathy among (known and suspect) diabetics in the sample") %>% 
  kable_styling(latex_options = c("scale_down","HOLD_position",font_size=8)) %>%
  row_spec(0,italic=TRUE) %>%
  add_header_above(c(" " = 1, "Female" = 3, "Male" = 3, "Total" = 3),bold=T) 


```

## Table DR6

```{r dr-grade-dr-in-diabetics, echo=FALSE}

source(here("RAAB7_scripts","dr-prev-dr-in-diabetics.R"))

ret.mac.prev.nice.names<-ret.mac.prev

ret.mac.prev.nice.names<-ret.mac.prev.nice.names[,c("grade","female.n","female.pct","male.n","male.pct","total.n","total.pct")]

write.table(ret.mac.prev.nice.names,here("outputs", ID, "summary", "data", "t35.csv"),row.names=F,col.names=T,sep=",")

ret.mac.prev.nice.names$grade[ret.mac.prev.nice.names$grade=="dr_retinopathy_grade_none"]<-"None (R0)"
ret.mac.prev.nice.names$grade[ret.mac.prev.nice.names$grade=="dr_retinopathy_grade_mild"]<-"Mild (R1)"
ret.mac.prev.nice.names$grade[ret.mac.prev.nice.names$grade=="dr_retinopathy_grade_observable"]<-"Observable (R2)"
ret.mac.prev.nice.names$grade[ret.mac.prev.nice.names$grade=="dr_retinopathy_grade_referable"]<-"Referable (R3)"
ret.mac.prev.nice.names$grade[ret.mac.prev.nice.names$grade=="dr_retinopathy_grade_proliferative"]<-"Proliferative (R4)"
ret.mac.prev.nice.names$grade[ret.mac.prev.nice.names$grade=="dr_retinopathy_grade_not_visualised"]<-"Not visualised (R6)"
ret.mac.prev.nice.names$grade[ret.mac.prev.nice.names$grade=="dr_maculopathy_grade_none"]<-"None (M0)"
ret.mac.prev.nice.names$grade[ret.mac.prev.nice.names$grade=="dr_maculopathy_grade_observable"]<-"Observable (M1)"
ret.mac.prev.nice.names$grade[ret.mac.prev.nice.names$grade=="dr_maculopathy_grade_referable"]<-"Referable (M2)"
ret.mac.prev.nice.names$grade[ret.mac.prev.nice.names$grade=="dr_maculopathy_grade_not_visualised"]<-"Not visualised (M6)"

names(ret.mac.prev.nice.names)<-c(" ","n","%","n","%","n","%")

knitr::kable(ret.mac.prev.nice.names, booktabs=T, linesep = "", caption = "Grade of retinopathy and maculopathy among (known and suspect) diabetics in the sample") %>% 
  kable_styling(full_width=T, latex_options = "HOLD_position") %>%
  row_spec(0,italic=TRUE) %>%
  column_spec(1,width='4cm') %>%
  pack_rows("Retinopathy",1,6) %>%
  pack_rows("Maculopathy",7,10) %>%
  add_header_above(c(" " = 1, "Female" = 2, "Male" = 2, "Total" = 2),bold=T) %>%
  add_footnote("Graded using the Scottish Diabetic Retinopathy Grading Scheme", notation="symbol")
```


Crude prevalence is reported among known or suspect diabetics who consented to dilated fundus examination (see Table DR5). At the person level, the grade of retinopathy and maculopathy is calculated as the higher of right and left eye grades (R0-4 and M0-2; see Table DR6).

A ‘rule of thirds’ has previously been applied to planning for diabetic retinopathy services. This estimates that approximately one third of people with diabetes have some level of retinopathy and, of those with retinopathy, approximately one third will have sight-threatening retinopathy (STDR) requiring laser or anti-VEGF treatment. A 2021 paper by To et al. emphasises there are regional differences in DR and STDR prevalence (https://doi.org/10.1016/j.ophtha.2021.04.027). 


## Table DR7

```{r dr-diabetes-vi,echo=FALSE}

source(here("RAAB7_scripts","dr-diabetes-vi.R"))

dm.vi.table.nice.names<-dm.vi.table

write.table(dm.vi.table.nice.names,here("outputs", ID, "summary", "data", "t36.csv"),row.names=F,col.names=T,sep=",")

dm.vi.table.nice.names$vi.level[dm.vi.table.nice.names$vi.level=="blind"]<-"Blind"
dm.vi.table.nice.names$vi.level[dm.vi.table.nice.names$vi.level=="severe.vi"]<-"Severe VI"
dm.vi.table.nice.names$vi.level[dm.vi.table.nice.names$vi.level=="moderate.vi"]<-"Moderate VI"
dm.vi.table.nice.names$vi.level[dm.vi.table.nice.names$vi.level=="mild.vi"]<-"Mild VI"

dm.vi.table.nice.names$diabetic.ci<-paste0(dm.vi.table.nice.names$diabetic.pct.lci," - ", dm.vi.table.nice.names$diabetic.pct.uci)
dm.vi.table.nice.names$non.diabetic.ci<-paste0(dm.vi.table.nice.names$non.diabetic.pct.lci," - ", dm.vi.table.nice.names$non.diabetic.pct.uci)

dm.vi.table.nice.names<-dm.vi.table.nice.names[,c("vi.level","diabetic.n","diabetic.pct","diabetic.ci","non.diabetic.n","non.diabetic.pct","non.diabetic.ci")]

names(dm.vi.table.nice.names)<-c(" ","n","%","95% CI","n","%","95% CI")

knitr::kable(dm.vi.table.nice.names, booktabs=T, linesep = "", caption = "The prevalence of vision impairment among known and suspected diabetics and non-diabetics") %>% 
  kable_styling(full_width=T, latex_options = "HOLD_position") %>%
  row_spec(0,italic=TRUE) %>%
  column_spec(1,width='4cm') %>%
  add_header_above(c("VI level" = 1, "Diabetics" = 3, "Non-diabetics" = 3),bold=T) 

```


The crude prevalence of vision impairment (due to any cause) by WHO categories among DR module participants with and without diabetes. 

\newpage

# Notes

## Abbreviations

CI = Confidence interval

DR = Diabetic retinopathy

PinVA = Pinhole visual acuity

PVA = Presenting visual acuity

VI = Vision impairment

## Snellen to logMAR conversion

Historic RAAB survey data variables have been updated to align with RAAB7 variable names and levels. RAAB7 records visual acuity in logMAR notation (or a code number representing light perception)

0.3 = Can see 6/12

0.47 = Cannot see 6/12 but can see 6/18

1.0 = Cannot see 6/18 but can see 6/60

1.3 = Cannot see 6/60 but can see 3/60

1.8 = Cannot see 3/60 but can see 1/60

3 = Light perception

4 = No light perception

## Bilateral VI

Blindness: PVA less than 3/60 in the better eye

Severe VI: PVA less than 6/60 to 3/60 in the better eye

Moderate VI: PVA less than 6/18 to 6/60 in the better eye

Mild VI: PVA less than 6/12 to 6/18 in the better eye

## Unilateral VI

Blindness: PVA less than 3/60 in one eye, PVA 6/12 in the other eye

Severe VI: PVA less than 6/60 to 3/60 in one eye, PVA 6/12 in the other eye

Moderate VI: PVA less than 6/18 to 6/60 in one eye, PVA 6/12 in the other eye

Mild VI: PVA less than 6/12 to 6/18 in one eye, PVA 6/12 in the other eye

## 95% Confidence Interval

The 95% confidence intervals are based on standard errors calculated for the clustering of the sample and the variability between clusters, specifically using the formula provided by:

Bennett S, Woods T, Liyanage WM, Smith DL. A simplified general method for cluster-sample surveys of health in developing countries. World Health Stat Q. 1991;44(3):98-106.
