---
output:
  pdf_document:
    toc: FALSE
---

```{r setup, include=FALSE}

require(rmarkdown)
require(readxl)
require(knitr)
require(tinytex)
require(kableExtra)
require(float)
require(RColorBrewer)
#install_tinytex()

require(tidyverse)
require(stringr)
require(treemap)
require(maditr)
require(here)

options(knitr.table.format = "latex")
knitr::opts_chunk$set(echo = FALSE)

if(dir.exists(here("outputs",ID))){
print("Directory already exists")
} else {
dir.create(here("outputs",ID,"/summary"))
dir.create(here("outputs",ID,"/summary/data"))
dir.create(here("outputs",ID,"/raw"))
dir.create(here("outputs",ID,"/raw/data"))
}

raab_merged<-read.csv(here("data", "surveys.csv"))

raab<-raab_merged[raab_merged$raab_id==ID,]
raab$date<-as.Date(raab$date)

pop_merged<-read.csv(here("data", "population.csv"))
									   
pop<-pop_merged[pop_merged$raab_id==ID,]
popfives<-pop

meta<-read.csv(here("data","meta.csv"))

raab_meta<-meta[meta$raab_id==ID,]

PI<-raab_meta$pi_name
TITLE<-raab_meta$survey_title

write.table(raab_meta, here("outputs", ID, "raw", "meta.csv"),row.names=F,col.names=T,sep=",",na="")
write.table(raab, here("outputs", ID, "raw", "data", "survey_data.csv"),row.names=F,col.names=T,sep=",")
write.table(popfives, here("outputs", ID, "raw", "data","population.csv"),row.names=F,col.names=T,sep=",")

source(here("RAAB7_scripts", "raab_functions.R"))

```

---
title: |
  <center>Rapid Assessment of Avoidable Blindness
  <center>Washington Group Questions module sub-report 
subtitle: |
  | 
  | Sub-report of findings from `r TITLE`
author: Principal Investigator `r PI`
output:
  pdf_document:
    toc: FALSE
header-includes:
- \usepackage{float}
- \usepackage{tabu}
- \usepackage{graphicx}
- \usepackage{fancyhdr}
- \fancypagestyle{plain}{\pagestyle{fancy}}
- \fancyhead[R]{\includegraphics[width=5cm]{logo.png}}
tables:
  yes
---

```{r raab_report_setup, include=FALSE}

source(here("RAAB7_scripts","RAAB7_report_setup.R"))

```

\center

Survey completed: `r format(max(raab$date), '%d %B %Y')`

Report generated: `r format(Sys.time(), '%d %B %Y')`

\raggedright

```{=latex}
\tableofcontents
```

\newpage

# Washington Group Questions

The United Nations Convention on the Rights of Persons with Disabilities (UN CRPD, 2006) defines disability as “long-term physical, mental, intellectual or sensory impairments which, in interaction with various barriers, may hinder [a person’s] full and effective participation in society on an equal basis with others”. 

The Washington Group Questions (WGQs) were developed by the Washington City Group, who were set up by the United Nations Statistical Division. They do NOT ask people whether or not they think they have a disability. Disability is strongly stigmatised in many settings, so instead they ask about difficulties in functioning, in line with the International Classification of Functioning, Disability and Health (the ICF).

  \begin{figure}
    \centering
    \includegraphics[width=5cm]{disability_impact.png}
    \caption{A schematic representation of the ways in which disability affects individuals and systems }
  \end{figure}

## Table WGQ1

```{r wgq-dis-prev,echo=FALSE}

source(here("RAAB7_scripts","wgq-dis-prev.R"))

wgq.domains.table.nice.names<-wgq.domains.table

write.table(wgq.domains.table.nice.names,here("outputs", ID, "summary", "data", "wgq1.csv"),row.names=F,col.names=T,sep=",")

names(wgq.domains.table.nice.names)<-c("","n","%","n","%","n","%")

knitr::kable(wgq.domains.table.nice.names, booktabs=T, linesep = "", caption = "Crude prevalence of self-reported disability by functional domain") %>% 
  kable_styling(full_width=T, latex_options = "HOLD_position") %>%
  row_spec(0,italic=TRUE) %>%
  column_spec(1,width='5cm') %>%
  add_header_above(c("Domain" = 1, "Female" = 2, "Male" = 2, "Total" = 2),bold=T)

```

## Figure WGQ1

```{r wgq_agegroups_1, echop=FALSE, fig.fullwidth=T}

wgq.plot<-wgq.domains.agegroups[1:4,]

wgq.range<-c(wgq.domains.agegroups$seeing.pct,wgq.domains.agegroups$hearing.pct,wgq.domains.agegroups$mobility.pct,wgq.domains.agegroups$memory.pct,wgq.domains.agegroups$communication.pct,wgq.domains.agegroups$selfcare.pct)

write.table(wgq.plot,here("outputs", ID, "summary", "data", "wgq_fig.csv"),row.names=F,col.names=T,sep=",")

wgq_fig_cols<-brewer.pal(6,"Spectral")

plot(as.numeric(as.factor(wgq.plot$age.groups.tens)),wgq.plot$seeing.pct,ylim=c(0,max(wgq.range)),bty='n',xaxt='n',yaxt='n',xlab="Age group (years)",ylab="%",pch=20,col=wgq_fig_cols[1])
lines(as.numeric(as.factor(wgq.plot$age.groups.tens)),wgq.plot$seeing.pct,col=wgq_fig_cols[1])
points(as.numeric(as.factor(wgq.plot$age.groups.tens)),wgq.plot$hearing.pct,pch=20,col=wgq_fig_cols[2])
lines(as.numeric(as.factor(wgq.plot$age.groups.tens)),wgq.plot$hearing.pct,col=wgq_fig_cols[2])
points(as.numeric(as.factor(wgq.plot$age.groups.tens)),wgq.plot$mobility.pct,pch=20,col=wgq_fig_cols[3])
lines(as.numeric(as.factor(wgq.plot$age.groups.tens)),wgq.plot$mobility.pct,col=wgq_fig_cols[3])
points(as.numeric(as.factor(wgq.plot$age.groups.tens)),wgq.plot$memory.pct,pch=20,col=wgq_fig_cols[4])
lines(as.numeric(as.factor(wgq.plot$age.groups.tens)),wgq.plot$memory.pct,col=wgq_fig_cols[4])
points(as.numeric(as.factor(wgq.plot$age.groups.tens)),wgq.plot$communication.pct,pch=20,col=wgq_fig_cols[5])
lines(as.numeric(as.factor(wgq.plot$age.groups.tens)),wgq.plot$communication.pct,col=wgq_fig_cols[5])
points(as.numeric(as.factor(wgq.plot$age.groups.tens)),wgq.plot$selfcare.pct,pch=20,col=wgq_fig_cols[6])
lines(as.numeric(as.factor(wgq.plot$age.groups.tens)),wgq.plot$selfcare.pct,col=wgq_fig_cols[6])

axis(1,at=c(-10,1,2,3,4,10),labels=c(-10,wgq.plot$age.groups.tens[1],wgq.plot$age.groups.tens[2],wgq.plot$age.groups.tens[3],wgq.plot$age.groups.tens[4],10),cex.axis=0.8)
axis(2,at=c(-10,0,10,20,30,40,50,60,70,80,90,100),labels=c(-10,0,10,20,30,40,50,60,70,80,90,100),cex.axis=0.8,las=2)
legend("topleft",c("Vision","Hearing","Mobility","Memory","Communication","Self-care"),col=wgq_fig_cols[1:6],pch=20,lty=1,bty='n',cex=0.8,inset=0.05)

```

Comment on prevalence of disability with age.

Comment on comparison of VI and eCSC among people with disability as a key equity indicator.

## Table WGQ2

```{r wgq-vi-crude-prev,echo=FALSE}

source(here("RAAB7_scripts","wgq-vi-prev.R"))

wgq.vi.table.a<-wgq.vi.table[,c("vi.level","any.dis.n","any.dis.pct","any.dis.pct.lci","any.dis.pct.uci","any.non.vi.dis.n","any.non.vi.dis.pct","any.non.vi.dis.pct.lci","any.non.vi.dis.pct.uci","no.dis.n","no.dis.pct","no.dis.pct.lci","no.dis.pct.uci")]

write.table(wgq.vi.table.a,here("outputs", ID, "summary", "data", "wgq2.csv"),row.names=F,col.names=T,sep=",")

wgq.vi.table.a$any.dis.ci<-paste0(wgq.vi.table.a$any.dis.pct.lci," - ",wgq.vi.table.a$any.dis.pct.uci)
wgq.vi.table.a$any.non.vi.dis.ci<-paste0(wgq.vi.table.a$any.non.vi.dis.pct.lci," - ",wgq.vi.table.a$any.non.vi.dis.pct.uci)
wgq.vi.table.a$no.dis.ci<-paste0(wgq.vi.table.a$no.dis.pct.lci," - ",wgq.vi.table.a$no.dis.pct.uci)

wgq.vi.table.a$vi.level[wgq.vi.table.a$vi.level=="blind"]<-"Blind"
wgq.vi.table.a$vi.level[wgq.vi.table.a$vi.level=="severe.vi"]<-"Severe"
wgq.vi.table.a$vi.level[wgq.vi.table.a$vi.level=="moderate.vi"]<-"Moderate"
wgq.vi.table.a$vi.level[wgq.vi.table.a$vi.level=="mild.vi"]<-"Mild"

wgq.vi.table.a<-wgq.vi.table.a[,c("vi.level","any.dis.n","any.dis.pct","any.dis.ci","any.non.vi.dis.n","any.non.vi.dis.pct","any.non.vi.dis.ci","no.dis.n","no.dis.pct","no.dis.ci")]

names(wgq.vi.table.a)<-c("","n","%","95% CI","n","%","95% CI","n","%","95% CI")

knitr::kable(wgq.vi.table.a, booktabs=T, linesep = "", caption = "Crude prevalence of vision impairment by disability status") %>% 
  kable_styling(latex_options = c("scale_down","HOLD_position"),font_size=8) %>%
  row_spec(0,italic=TRUE) %>%
  add_header_above(c("VI level" = 1, "Any disability" = 3, "Any non-seeing disability" = 3, "No disability" = 3),bold=T)

```

## Table WGQ3

```{r wgq-vi-adj-prev,echo=FALSE}

source(here("RAAB7_scripts","wgq-vi-prev.R"))

wgq.vi.table.b<-wgq.vi.table[,c("vi.level","any.dis.adj.pct","any.dis.adj.pct.lci","any.dis.adj.pct.uci","any.non.vi.dis.adj.pct","any.non.vi.dis.adj.pct.lci","any.non.vi.dis.adj.pct.uci","no.dis.adj.pct","no.dis.adj.pct.lci","no.dis.adj.pct.uci")]

write.table(wgq.vi.table.b,here("outputs", ID, "summary", "data", "wgq3.csv"),row.names=F,col.names=T,sep=",")

wgq.vi.table.b$any.dis.adj.ci<-paste0(wgq.vi.table.b$any.dis.adj.pct.lci," - ",wgq.vi.table.b$any.dis.adj.pct.uci)
wgq.vi.table.b$any.non.vi.dis.adj.ci<-paste0(wgq.vi.table.b$any.non.vi.dis.adj.pct.lci," - ",wgq.vi.table.b$any.non.vi.dis.adj.pct.uci)
wgq.vi.table.b$no.dis.adj.ci<-paste0(wgq.vi.table.b$no.dis.adj.pct.lci," - ",wgq.vi.table.b$no.dis.adj.pct.uci)

wgq.vi.table.b$vi.level[wgq.vi.table.b$vi.level=="blind"]<-"Blind"
wgq.vi.table.b$vi.level[wgq.vi.table.b$vi.level=="severe.vi"]<-"Severe"
wgq.vi.table.b$vi.level[wgq.vi.table.b$vi.level=="moderate.vi"]<-"Moderate"
wgq.vi.table.b$vi.level[wgq.vi.table.b$vi.level=="mild.vi"]<-"Mild"

wgq.vi.table.b<-wgq.vi.table.b[,c("vi.level","any.dis.adj.pct","any.dis.adj.ci","any.non.vi.dis.adj.pct","any.non.vi.dis.adj.ci","no.dis.adj.pct","no.dis.adj.ci")]

names(wgq.vi.table.b)<-c("","Adj. %","95% CI","Adj. %","95% CI","Adj. %","95% CI")

knitr::kable(wgq.vi.table.b, booktabs=T, linesep = "", caption = "Adjusted prevalence of vision impairment by disability status") %>% 
  kable_styling(full_width=T, latex_options = "HOLD_position") %>%
  row_spec(0,italic=TRUE) %>%
  add_header_above(c("VI level" = 1, "Any disability" = 2, "Any non-seeing disability" = 2, "No disability" = 2),bold=T)

```


## Table WGQ4

```{r wgq-ecsc-adj, echo=FALSE}

source(here("RAAB7_scripts","wgq-ecsc.R"))

wgq.ecsc.nice.names<-wgq.ecsc[wgq.ecsc$num.thresh=="ecsc_612",]

wgq.ecsc.nice.names$any.dis.adjusted.ci<-paste0(wgq.ecsc.nice.names$any.dis.adjusted.lci," - ",wgq.ecsc.nice.names$any.dis.adjusted.uci)
wgq.ecsc.nice.names$any.non.vi.dis.adjusted.ci<-paste0(wgq.ecsc.nice.names$any.non.vi.dis.adjusted.lci," - ",wgq.ecsc.nice.names$any.non.vi.dis.adjusted.uci)
wgq.ecsc.nice.names$no.dis.adjusted.ci<-paste0(wgq.ecsc.nice.names$no.dis.adjusted.lci," - ",wgq.ecsc.nice.names$no.dis.adjusted.uci)

wgq.ecsc.nice.names$num.thresh<-"eCSC"

wgq.ecsc.nice.names<-wgq.ecsc.nice.names[,c("num.thresh","any.dis.adjusted","any.dis.adjusted.ci","any.non.vi.dis.adjusted","any.non.vi.dis.adjusted.ci","no.dis.adjusted","no.dis.adjusted.ci")]

write.table(wgq.ecsc.nice.names,here("outputs", ID, "summary", "data", "wgq4.csv"),row.names=F,col.names=T,sep=",")

names(wgq.ecsc.nice.names)<-c("","Adj. %","95% CI","Adj. %","95% CI","Adj. %","95% CI")

knitr::kable(wgq.ecsc.nice.names, booktabs=T, linesep = "", caption = "Adjusted effective cataract surgical coverage by disability status",row.names=F) %>%
  kable_styling(latex_options = c("scale_down","HOLD_position"),font_size=8) %>%
  row_spec(0,italic=TRUE) %>%
  column_spec(1,width='4cm') %>%
  pack_rows("Cataract surgical threshold <6/12",1,1) %>%
  pack_rows("Cataract surgical threshold <6/18",2,2) %>%
  pack_rows("Cataract surgical threshold <6/60",3,3) %>%
  pack_rows("Cataract surgical threshold <3/60",4,4) %>%
  add_header_above(c(" " = 1, "Any disability" = 2, "Any non-seeing disability" = 2, "No disbaility" = 2),bold=T) %>%
  add_footnote("eCSC: Effective Cataract Surgical Coverage",notation="symbol")



```


